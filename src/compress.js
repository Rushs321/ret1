"use strict";import sharp from"sharp";import{redirect}from"./redirect.js";const sharpStream=()=>sharp({animated:false,unlimited:true});export async function compressImg(r,a,e){const t=r.params.webp?"webp":"jpeg";try{const s=sharpStream().grayscale(r.params.grayscale).toFormat(t,{quality:r.params.quality,progressive:true,optimizeScans:true,smartSubsample:false});e.body.pipe(s);const{data:i,info:o}=await s.toBuffer({resolveWithObject:true});a.header("content-type","image/"+t).header("content-length",o.size).header("x-original-size",r.params.originSize).header("x-bytes-saved",r.params.originSize-o.size).code(200).send(i)}catch(e){return redirect(r,a)}}
